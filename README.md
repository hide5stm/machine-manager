# サーバ在庫管理システム

Streamlitベースのサーバ在庫管理システムです。Google OAuth2認証、楽観的ロック、編集履歴機能を備えています。

## 機能

- **サーバ管理**: サーバの追加、編集、削除
- **認証機能**: Google OAuth2認証
- **楽観的ロック**: 複数ユーザーによる同時編集時の競合検出と解決
- **編集履歴**: 全ての変更履歴を記録
- **検索機能**: サーバ情報の検索・フィルタリング
- **データエクスポート**: CSV形式でのデータ出力

## 楽観的ロックについて

このシステムでは楽観的ロック（Optimistic Locking）を採用しています：

- **バージョン管理**: 各サーバレコードにバージョン番号を付与
- **競合検出**: 更新時に期待するバージョンと現在のバージョンを比較
- **競合解決**: 競合が発生した場合、最新情報を表示してユーザーに再編集を促す
- **パフォーマンス**: 悲観的ロックと比較してデッドロックが発生せず、スケーラブル

### 楽観的ロックの動作

1. ユーザーがサーバ編集画面を開く
2. 現在のバージョン番号を取得
3. ユーザーが編集を行い、更新ボタンを押す
4. 更新時に元のバージョン番号をチェック
5. 他のユーザーが先に更新していた場合は競合エラーを表示
6. ユーザーは最新情報を確認して再度編集

## プロジェクト構造

```
server_inventory/
├── main.py                 # メインアプリケーション
├── config.py              # 設定ファイル
├── database.py            # データベース操作
├── auth.py                # 認証管理
├── lock_manager.py        # 楽観的ロック管理
├── history_manager.py     # 履歴管理
├── server_service.py      # サーバ業務ロジック
├── ui_components.py       # UI共通コンポーネント
├── pages.py               # ページ表示ロジック
├── requirements.txt       # 依存関係
└── README.md             # このファイル
```

## セットアップ

1. **依存関係のインストール**
   ```bash
   pip install -r requirements.txt
   ```

2. **環境変数の設定**
   ```bash
   export GOOGLE_CLIENT_ID="your_google_client_id"
   ```

3. **アプリケーションの起動**
   ```bash
   streamlit run main.py
   ```

## モジュール詳細

### config.py
- アプリケーション全体の設定を管理
- データベースパス、認証設定、フィールドマッピングなど

### database.py
- SQLiteデータベースの初期化と基本操作
- バージョン管理機能付きのCRUD操作
- `DatabaseManager`クラスで楽観的ロック対応の更新処理を提供

### auth.py
- Google OAuth2認証の管理
- ユーザーセッション管理
- `AuthManager`クラスで認証状態を管理

### lock_manager.py
- 楽観的ロック機能の実装
- バージョン競合の検出
- `OptimisticLockManager`クラスで競合チェック機能を提供

### history_manager.py
- 編集履歴の記録と取得
- 変更内容の詳細な記録
- `HistoryManager`クラスで履歴操作を提供

### server_service.py
- サーバに関する業務ロジック
- 楽観的ロックを使った更新処理
- `ServerService`クラスで高レベルな操作を提供

### ui_components.py
- UI共通コンポーネント
- 競合エラー表示機能
- `UIComponents`クラスで各種UI要素を提供

### pages.py
- 各ページの表示ロジック
- 競合処理を含むフォーム処理
- `PageRenderer`クラスでページ表示を統合

### main.py
- アプリケーションのエントリーポイント
- 全体の流れを制御

## 使用方法

1. **ログイン**: Googleアカウントでログイン（開発環境では簡易ログイン）
2. **サーバ一覧**: 登録されているサーバの確認・検索
3. **サーバ追加**: 新規サーバの登録
4. **サーバ編集**: 既存サーバ情報の更新（楽観的ロック付き）
5. **編集履歴**: 変更履歴の確認
6. **データ管理**: 統計情報の確認、CSVエクスポート

## 楽観的ロック vs 悲観的ロック

| 特徴 | 楽観的ロック | 悲観的ロック |
|------|-------------|-------------|
| **ロック取得** | 更新時のみ | 読み取り時から |
| **パフォーマンス** | 高い | 低い |
| **デッドロック** | 発生しない | 発生可能 |
| **競合頻度** | 低い環境に適する | 高い環境に適する |
| **実装複雑度** | 中程度 | 高い |

このサーバ在庫管理システムでは、同時編集の頻度が比較的低いと想定されるため、楽観的ロックが適しています。

## 注意事項

- 開発環境では簡易ログインを使用していますが、本番環境では適切なGoogle OAuth2フローを実装してください
- データベースファイル（server_inventory.db）は自動的に作成されます
- 楽観的ロックにより、競合が発生した場合はユーザーに再編集を促します

## 今後の拡張案

- ファイルアップロード機能
- より詳細な権限管理
- 通知機能
- レポート機能の強化
- REST API の提供
- 自動マージ機能（非競合フィールドの場合）
